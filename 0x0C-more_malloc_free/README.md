This is the more malloc free code
